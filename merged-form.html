<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CEFINEA | IN PHI·∫æU K·∫æT QU·∫¢</title>
    <style>
      /* C·∫•u h√¨nh chung cho trang */
      body {
        font-family: 'Times New Roman', Times, serif;
        margin: 0;
        padding: 0;
        background-color: #f0f0f0; /* M√†u n·ªÅn web ƒë·ªÉ d·ªÖ nh√¨n khung gi·∫•y */
      }

      /* Khung gi·∫•y A4 hi·ªÉn th·ªã tr√™n m√†n h√¨nh */
      .page {
        width: 210mm;
        min-height: 297mm;
        padding: 0.92cm 1.05cm 1.43cm 1.9cm;
        margin: 20px auto;
        background: white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
        position: relative;
      }

      /* N√∫t in */
      .btn-print {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        border-radius: 5px;
        z-index: 9999;
      }

      /* --- 1. HEADER BRAND (LOGO & ƒê·ªäA CH·ªà) --- */
      .brand-table {
        margin-bottom: 15px;
        border: none;
      }
      .brand-table td {
        padding: 2px;
      }
      .logo-cell {
        width: 80px;
        vertical-align: middle;
        text-align: center;
      }
      .logo-img {
        width: 70px; /* Ch·ªânh k√≠ch th∆∞·ªõc logo t·∫°i ƒë√¢y */
        height: auto;
      }
      .org-name {
        font-weight: bold;
        font-size: 10pt;
        text-transform: uppercase;
        padding-left: 10px;
        line-height: 1.4;
      }
      .org-contact {
        font-size: 10pt;
        /* padding-left: 20px; */
        line-height: 1.4;
      }

      /* --- 2. KHUNG TI√äU ƒê·ªÄ (BOX C√ì VI·ªÄN) --- */
      .title-box-table {
        border: 1px solid black; /* Khung vi·ªÅn ƒëen bao quanh */
        margin-bottom: 10px;
      }
      .title-box-table td {
        padding: 10px 5px;
        vertical-align: middle;
      }
      /* ƒê∆∞·ªùng k·∫ª d·ªçc ch·∫•m bi ngƒÉn c√°ch c√°c √¥ */
      .border-right-dotted {
        border-right: 1px dotted black;
      }
      .so-pkq {
        font-size: 11pt;
        text-align: center;
        width: 20%;
      }
      .main-title {
        text-align: center;
        width: 60%;
      }
      .ky-hieu {
        font-size: 11pt;
        text-align: center;
        width: 20%;
      }

      /* --- 3. TH√îNG TIN KH√ÅCH H√ÄNG --- */
      .info-table {
        margin-bottom: 10px;
        font-size: 12pt;
      }
      .info-table td {
        padding: 3px 0;
      }
      .lbl {
        white-space: nowrap;
        width: 1px;
        padding-right: 5px;
      }
      .val {
        font-weight: bold;
      }

      /* B·ªë c·ª•c n·ªôi dung */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
      }

      .header-table td {
        vertical-align: top;
      }

      .title {
        text-align: center;
        font-weight: bold;
        font-size: 16pt;
        margin-bottom: 5px;
      }
      .sub-title {
        text-align: center;
        font-weight: bold;
        font-size: 14pt;
        font-style: italic;
        margin-bottom: 20px;
      }

      /* Th√¥ng tin kh√°ch h√†ng */
      .info-table td {
        padding: 5px 0;
        font-size: 12pt;
      }
      .label {
        width: 130px;
        font-weight: bold;
      }
      .colon {
        width: 20px;
        text-align: center;
      }

      /* B·∫£ng k·∫øt qu·∫£ */
      /* B·∫Øt bu·ªôc ng·∫Øt sang trang m·ªõi sau m·ªói b·∫£ng k·∫øt qu·∫£ */
      .result-table {
        display: block; /* Gi√∫p tr√¨nh duy·ªát hi·ªÉu kh·ªëi n√†y c·∫ßn ng·∫Øt */
        width: 100%; /* ƒê·∫£m b·∫£o b·∫£ng v·∫´n r·ªông 100% khi display block */
      }

      .result-table th,
      .result-table td {
        border: 1px solid black;
        padding: 5px;
        text-align: center;
        font-size: 12pt;
      }
      .result-table th {
        background-color: #fff; /* Tr√°nh m√†u n·ªÅn khi in */
        /* background-color: #e8e8e8; */
      }

      /* Ghi ch√∫ */
      .notes {
        font-size: 10pt;
        font-style: italic;
        margin-top: 10px;
        line-height: 1.4;
      }

      /* Ch·ªØ k√Ω */
      .footer-date {
        text-align: right;
        font-style: italic;
        margin-top: 20px;
        margin-bottom: 10px;
        font-size: 12pt;
      }
      .signature-table td {
        text-align: center;
        vertical-align: top;
        font-size: 12pt;
      }
      .signature-title {
        font-weight: bold;
        display: block;
        margin-bottom: 80px; /* Kho·∫£ng tr·ªëng k√Ω t√™n */
      }
      .signature-name {
        font-weight: bold;
        display: block;
      }

      /* --- C·∫•u h√¨nh IN ·∫§N (ƒê√£ s·ª≠a) --- */
      @media print {
        body {
          background: none;
          -webkit-print-color-adjust: exact;
        }

        /* Bao b·ªçc ph·∫ßn ghi ch√∫ v√† ch·ªØ k√Ω */
        .footer-date,
        .notes,
        .signature-table {
          page-break-inside: avoid; /* Tr√°nh b·ªã c·∫Øt ƒë√¥i n·ªôi dung b√™n trong */
        }

        .footer-group {
          /* T·∫°o kho·∫£ng c√°ch v·ªõi b·∫£ng k·∫øt qu·∫£ b√™n tr√™n */
          margin-top: 20px;

          /* C·∫•m m√°y in c·∫Øt ƒë√¥i kh·ªëi n√†y */
          page-break-inside: avoid; /* Cho tr√¨nh duy·ªát c≈© */
          break-inside: avoid; /* Cho tr√¨nh duy·ªát m·ªõi (Chrome/Edge) */

          /* ƒê·∫£m b·∫£o kh·ªëi hi·ªÉn th·ªã d·∫°ng block ƒë·ªÉ t√≠nh to√°n l·ªÅ ƒë√∫ng */
          display: block;
          width: 100%;
        }

        @page {
          size: A4;
          /* QUAN TR·ªåNG: Thi·∫øt l·∫≠p l·ªÅ c·ª©ng cho m√°y in (Tr√™n - Ph·∫£i - D∆∞·ªõi - Tr√°i) */
          /* Gi·ªëng nh∆∞ Page Setup trong Word */
          margin: 1.5cm 1.5cm 1.5cm 2cm;
        }

        .page {
          /* V√¨ @page ƒë√£ c√≥ margin r·ªìi, n√™n margin/padding c·ªßa div n√†y ph·∫£i v·ªÅ 0 */
          /* ƒë·ªÉ tr√°nh b·ªã l·ªÅ k√©p (double margin) l√†m n·ªôi dung b·ªã b√≥p nh·ªè */
          margin: 0;
          padding: 0;
          border: none; /* B·ªè vi·ªÅn b√≥ng */
          box-shadow: none;
          width: 100%;
          height: auto;
        }

        .no-print {
          display: none;
        }

        /* ƒê·∫£m b·∫£o b·∫£ng l·∫∑p l·∫°i header ƒë√∫ng chu·∫©n */
        thead {
          display: table-header-group;
        }
        tfoot {
          display: table-footer-group;
        }
        /* Tr√°nh ng·∫Øt trang gi·ªØa d√≤ng */
        tr {
          page-break-inside: avoid;
        }
      }
    </style>
  </head>
  <body>
    <button class="btn-print no-print" onclick="window.print()">üñ®Ô∏è In Phi·∫øu PDF</button>

    <div class="page">
      <table class="main-wrapper-table">
        <thead>
          <tr>
            <td>
              <table class="brand-table">
                <tr>
                  <td class="logo-cell">
                    <img src="./assets/img/form/logo.jpg" alt="Logo" class="logo-img" />
                  </td>

                  <td style="width: 48%; vertical-align: top">
                    <div class="org-name">
                      VI·ªÜN M√îI TR∆Ø·ªúNG & T√ÄI NGUY√äN<br />
                      TRUNG T√ÇM C√îNG NGH·ªÜ M√îI TR∆Ø·ªúNG<br />
                      PTN PH√ÇN T√çCH & K·ª∏ THU·∫¨T C√îNG NGH·ªÜ<br />
                      (VIMCERTS 077)
                    </div>
                  </td>

                  <td style="width: 53%; vertical-align: top">
                    <div class="org-contact">
                      Tr·ª• s·ªü ch√≠nh: 142 T√¥ Hi·∫øn Th√†nh, P.Di√™n H·ªìng, Tp.HCM<br />
                      ƒê·ªãa ch·ªâ PTN: Khu ƒë√¥ th·ªã ƒê·∫°i H·ªçc Qu·ªëc Gia,<br />
                      P. ƒê√¥ng H√≤a, Tp. HCM<br />
                      Tel: 028.2252.4567 - Hotline: 0799435426<br />
                      Email: ketquacefinea@gmail.com
                    </div>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <table class="title-box-table">
                <tr>
                  <td class="so-pkq border-right-dotted">
                    <div style="text-decoration: underline">S·ªë PKQ:</div>
                    <div id="so_phieu" style="font-weight: bold; margin-top: 5px">.../.../PKQ</div>
                  </td>
                  <td class="main-title border-right-dotted">
                    <div style="font-weight: bold; font-size: 16pt; text-transform: uppercase">
                      PHI·∫æU K·∫æT QU·∫¢ TH·ª¨ NGHI·ªÜM
                    </div>
                    <div style="font-weight: bold; font-size: 14pt">TEST REPORT</div>
                  </td>
                  <td class="ky-hieu">
                    <div style="text-decoration: underline">K√≠ hi·ªáu m·∫´u:</div>
                    <div id="ky_hieu_mau" style="font-weight: bold; margin-top: 5px">...</div>
                  </td>
                </tr>
              </table>

              <table class="info-table">
                <tr>
                  <td class="lbl">T√™n kh√°ch h√†ng</td>
                  <td>: <span id="ten_khach_hang" class="val" style="text-transform: uppercase">...</span></td>
                  <td class="lbl" style="padding-left: 20px">Ng√†y nh·∫≠n m·∫´u</td>
                  <td style="width: 120px">: <span id="ngay_nhan_mau">../../....</span></td>
                </tr>
                <tr>
                  <td class="lbl">ƒê·ªãa ch·ªâ l·∫•y m·∫´u</td>
                  <td>: <span id="dia_chi">...</span></td>
                  <td class="lbl" style="padding-left: 20px">Lo·∫°i m·∫´u</td>
                  <td>: <span id="loai_mau">...</span></td>
                </tr>
                <!-- <tr>
                  <td class="lbl">V·ªã tr√≠ l·∫•y m·∫´u</td>
                  <td colspan="3">: <span style="font-weight: bold">25.4471.KT5:</span>V·ªã tr√≠...</td>
                </tr>
                <tr>
                  <td class="lbl"></td>
                  <td colspan="3">: <span style="font-weight: bold">25.4471.KT6:</span>V·ªã tr√≠...</td>
                </tr>
                <tr>
                  <td class="lbl"></td>
                  <td colspan="3">: <span style="font-weight: bold">25.4471.KT7:</span>V·ªã tr√≠...</td>
                </tr>
                <tr>
                  <td class="lbl"></td>
                  <td colspan="3">: <span style="font-weight: bold">25.4471.KT7:</span>V·ªã tr√≠...</td>
                </tr> -->
              </table>

              <div id="tables-container"></div>

              <!-- <table class="result-table">
                <thead>
                  <tr>
                    <th rowspan="2" style="width: 50px">TT</th>
                    <th rowspan="2">Ch·ªâ ti√™u</th>
                    <th rowspan="2" style="width: 95px">ƒê∆°n v·ªã</th>
                    <th rowspan="2" style="width: 200px">Ph∆∞∆°ng ph√°p th·ª≠</th>
                    <th colspan="3">K·∫øt qu·∫£</th>
                    <th>QCVN 19:2009 BTNMT</th>
                    <th>QCVN 20:2009 BTNMT</th>
                  </tr>
                  <tr>
                    <th><span>25.4471.KT5</span></th>
                    <th><span>25.4471.KT6</span></th>
                    <th><span>25.4471.KT7</span></th>
                    <th>C·ªôt B Kp=0,8 v√† Kv=1</th>
                    <th>N·ªìng ƒë·ªô t·ªëi ƒëa</th>
                  </tr>
                </thead>
                <tbody id="table_body">
                  <tr>
                    <td>1</td>
                    <td style="text-align: left">D·∫ßu m·ª°(b)</td>
                    <td>mg/L</td>
                    <td>SMEWW 5520B&F:2023</td>
                    <td>KPH (LOD=1)</td>
                    <td>KPH (LOD=1)</td>
                    <td>KPH (LOD=1)</td>
                    <td>40</td>
                    <td>-</td>
                  </tr>
                </tbody>
              </table>

              <table class="result-table">
                <thead>
                  <tr>
                    <th rowspan="2" style="width: 50px">TT</th>
                    <th rowspan="2">Ch·ªâ ti√™u</th>
                    <th rowspan="2" style="width: 95px">ƒê∆°n v·ªã</th>
                    <th rowspan="2" style="width: 200px">Ph∆∞∆°ng ph√°p th·ª≠</th>
                    <th colspan="3">K·∫øt qu·∫£</th>
                    <th>QCVN 19:2009 BTNMT</th>
                    <th>QCVN 20:2009 BTNMT</th>
                  </tr>
                  <tr>
                    <th><span>25.4471.KT5</span></th>
                    <th><span>25.4471.KT6</span></th>
                    <th><span>25.4471.KT7</span></th>
                    <th>C·ªôt B Kp=0,8 v√† Kv=1</th>
                    <th>N·ªìng ƒë·ªô t·ªëi ƒëa</th>
                  </tr>
                </thead>
                <tbody id="table_body">
                  <tr>
                    <td>1</td>
                    <td style="text-align: left">D·∫ßu m·ª°(b)</td>
                    <td>mg/L</td>
                    <td>SMEWW 5520B&F:2023</td>
                    <td>KPH (LOD=1)</td>
                    <td>KPH (LOD=1)</td>
                    <td>KPH (LOD=1)</td>
                    <td>40</td>
                    <td>-</td>
                  </tr>
                </tbody>
              </table>

              <table class="result-table">
                <thead>
                  <tr>
                    <th rowspan="2" style="width: 50px">TT</th>
                    <th rowspan="2">Ch·ªâ ti√™u</th>
                    <th rowspan="2" style="width: 95px">ƒê∆°n v·ªã</th>
                    <th rowspan="2" style="width: 200px">Ph∆∞∆°ng ph√°p th·ª≠</th>
                    <th colspan="3">K·∫øt qu·∫£</th>
                    <th>QCVN 19:2009 BTNMT</th>
                    <th>QCVN 20:2009 BTNMT</th>
                  </tr>
                  <tr>
                    <th><span>25.4471.KT5</span></th>
                    <th><span>25.4471.KT6</span></th>
                    <th><span>25.4471.KT7</span></th>
                    <th>C·ªôt B Kp=0,8 v√† Kv=1</th>
                    <th>N·ªìng ƒë·ªô t·ªëi ƒëa</th>
                  </tr>
                </thead>
                <tbody id="table_body">
                  <tr>
                    <td>1</td>
                    <td style="text-align: left">D·∫ßu m·ª°(b)</td>
                    <td>mg/L</td>
                    <td>SMEWW 5520B&F:2023</td>
                    <td>KPH (LOD=1)</td>
                    <td>KPH (LOD=1)</td>
                    <td>KPH (LOD=1)</td>
                    <td>40</td>
                    <td>-</td>
                  </tr>
                </tbody>
              </table> -->

              <div class="footer-group">
                <div class="notes">
                  <span style="text-decoration: underline; font-weight: bold">Ghi ch√∫:</span><br />
                  1. (b)- Th√¥ng s·ªë ƒë√£ ƒë∆∞·ª£c B·ªô T√†i nguy√™n v√† M√¥i tr∆∞·ªùng c√¥ng nh·∫≠n (S·ªë hi·ªáu VIMCERTS 077);<br />
                  2. KPH: Kh√¥ng ph√°t hi·ªán; LOD: Gi·ªõi h·∫°n ph√°t hi·ªán c·ªßa ph∆∞∆°ng ph√°p;<br />
                  3. Th√¥ng tin t√™n kh√°ch h√†ng v√† m·∫´u th·ª≠ ƒë∆∞·ª£c ghi tr√™n phi·∫øu k·∫øt qu·∫£ n√†y theo y√™u c·∫ßu kh√°ch h√†ng;<br />
                  4. C√°c k·∫øt qu·∫£ ph√¢n t√≠ch ch·ªâ c√≥ gi√° tr·ªã tr√™n m·∫´u th·ª≠/t·∫°i th·ªùi ƒëi·ªÉm ƒëo;<br />
                  5. Th·ªùi gian l∆∞u m·∫´u: 7 ng√†y k·ªÉ t·ª´ ng√†y tr·∫£ k·∫øt qu·∫£ ƒë·ªëi v·ªõi m·∫´u ƒë·∫•t, n∆∞·ªõc, b√πn, ch·∫•t th·∫£i, kh√¥ng l∆∞u
                  ƒë·ªëi v·ªõi m·∫´u kh√≠, vi sinh;<br />
                  6. Kh√¥ng ƒë∆∞·ª£c tr√≠ch sao m·ªôt ph·∫ßn ho·∫∑c to√†n b·ªô phi·∫øu k·∫øt qu·∫£ th·ª≠ nghi·ªám n·∫øu kh√¥ng c√≥ s·ª± ƒë·ªìng √Ω c·ªßa
                  Trung t√¢m C√¥ng ngh·ªá M√¥i tr∆∞·ªùng.
                </div>

                <div class="footer-date" id="footer_date">Tp. H·ªì Ch√≠ Minh, ng√†y ... th√°ng ... nƒÉm ...</div>

                <table class="signature-table">
                  <tbody>
                    <tr>
                      <td style="width: 33%">
                        <span class="signature-title">Ph·ª• tr√°ch k·ªπ thu·∫≠t</span>
                        <span class="signature-name">KS. Tr·∫ßn Th·ªã Ph∆∞∆°ng Linh</span>
                      </td>
                      <td style="width: 33%">
                        <span class="signature-title">Tr∆∞·ªüng ph√≤ng PTN</span>
                        <span class="signature-name">ThS. Phan Th·ªã Ho√†i Trinh</span>
                      </td>
                      <td style="width: 33%">
                        <span class="signature-title">Gi√°m ƒë·ªëc</span>
                        <span class="signature-name">TS. Nguy·ªÖn Nh∆∞ Hi·ªÉn</span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      // H√†m l·∫•y tham s·ªë t·ª´ URL
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      // H√†m t·∫°o m·∫£ng con (Chunking array) - Logic chia 3-3-1 n·∫±m ·ªü ƒë√¢y
      function chunkArray(myArray, chunk_size) {
        const results = [];
        while (myArray.length) {
          results.push(myArray.splice(0, chunk_size));
        }
        return results;
      }

      // H√†m ƒëi·ªÅn d·ªØ li·ªáu v√†o form khi trang t·∫£i xong
      window.onload = function () {
        // Danh s√°ch c√°c tr∆∞·ªùng c·∫ßn ƒëi·ªÅn (id trong HTML : t√™n tham s·ªë tr√™n URL)
        const fields = {
          so_phieu: 'so_phieu',
          ky_hieu_mau: 'ky_hieu_mau',
          ten_khach_hang: 'ten_khach_hang',
          dia_chi: 'dia_chi',
          ngay_nhan_mau: 'ngay_nhan_mau',
          loai_mau: 'loai_mau',
          footer_date: 'ngay_in'
        };

        // L·∫∑p v√† ƒëi·ªÅn d·ªØ li·ªáu text c∆° b·∫£n
        for (const [id, param] of Object.entries(fields)) {
          const value = getQueryParam(param);

          // N·∫øu l√† footer_date, ƒë·ªãnh d·∫°ng ng√†y th√°ng (tham s·ªë nh·∫≠n l√† dd/mm/yyyy)
          if (id === 'footer_date' && value) {
            const parts = value.split('/');
            const date = new Date(parts[2], parts[1] - 1, parts[0]);
            const formattedDate = `${date.getDate()} th√°ng ${date.getMonth() + 1} nƒÉm ${date.getFullYear()}`;
            document.getElementById(id).innerText = `Tp. H·ªì Ch√≠ Minh, ng√†y ${formattedDate}`;
            continue;
          }

          if (value) {
            document.getElementById(id).innerText = decodeURIComponent(value);
          }
        }

        // merged-form.html?so_phieu=12/2025/PKQ&ky_hieu_mau=25.4999.NT1&ten_khach_hang=C√îNG%20TY%20A&ngay_nhan_mau=04/12/2025&dia_chi=T·ªânh%20B&loai_mau=N∆∞·ªõc%20th·∫£i&ngay_in=14/12/2025&vi_tri_lay_mau=LA,TG,HCM,DT&ma_mau_ids=13e9024c,13e9024c,13e9024c,13e9024c
        // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho b·∫£ng k·∫øt qu·∫£ (N·∫øu truy·ªÅn JSON qua URL)
        // L·∫•y tham s·ªë ma_mau_id
        const maMauIdsParam = getQueryParam('ma_mau_ids');
        // C·∫•u h√¨nh API PostgreSQL
        const POSTGRESQL_API_CONFIG = {
          baseUrl: 'https://api-cefinea.tamk.win',
          endpoints: {
            chiTietMau: '/cefinea/chi-tiet-mau/search'
          },
          token: 'GPEMS-zzzz',
          maxSamplesPerTable: 3 // QUY ƒê·ªäNH: T·ªëi ƒëa 3 m·∫´u tr√™n 1 b·∫£ng
        };
        // D·ª±a tr√™n m√£ m·∫´u id n√†y fetch api get danh s√°ch chi-tiet-mau c√≥ ma_mau_id t∆∞∆°ng ·ª©ng
        if (maMauIdsParam) {
          const listIds = maMauIdsParam.split(',');

          // X·ª≠ l√Ω v·ªã tr√≠ l·∫•y m·∫´u (n·∫øu c√≥)
          // L·∫•y tham s·ªë v·ªã_tri_lay_mau
          const viTriLayMauParam = getQueryParam('vi_tri_lay_mau');
          if (viTriLayMauParam) {
            const viTriList = viTriLayMauParam.split(',');
            const infoTable = document.querySelector('.info-table');

            viTriList.forEach((viTri, index) => {
              const row = document.createElement('tr');

              // <tr>
              //       <td class="lbl">V·ªã tr√≠ l·∫•y m·∫´u</td>
              //       <td colspan="3">: <span style="font-weight: bold">25.4471.KT5:</span>V·ªã tr√≠...</td>
              //     </tr>
              //     <tr>
              //       <td class="lbl"></td>
              //       <td colspan="3">: <span style="font-weight: bold">25.4471.KT6:</span>V·ªã tr√≠...</td>
              //     </tr>
              //     <tr>
              //       <td class="lbl"></td>
              //       <td colspan="3">: <span style="font-weight: bold">25.4471.KT7:</span>V·ªã tr√≠...</td>
              //     </tr>
              //     <tr>
              //       <td class="lbl"></td>
              //       <td colspan="3">: <span style="font-weight: bold">25.4471.KT7:</span>V·ªã tr√≠...</td>
              //     </tr>

              const lblCell = document.createElement('td');
              lblCell.className = 'lbl';
              lblCell.innerHTML = index === 0 ? 'V·ªã tr√≠ l·∫•y m·∫´u' : '';
              row.appendChild(lblCell);

              const valCell = document.createElement('td');
              valCell.colSpan = 3;
              valCell.innerHTML = `: <span style="font-weight: bold">${listIds[index]}:</span>${viTri.split(':')[0]}`;
              row.appendChild(valCell);

              infoTable.appendChild(row);
            });
          }

          const container = document.getElementById('tables-container');
          container.innerHTML = '<div>ƒêang t·∫£i d·ªØ li·ªáu...</div>';

          // T·∫°o danh s√°ch c√°c Promise (l·ªánh g·ªçi API) ch·∫°y song song
          const apiCalls = listIds.map(id => {
            return fetch(`${POSTGRESQL_API_CONFIG.baseUrl}${POSTGRESQL_API_CONFIG.endpoints.chiTietMau}`, {
              method: 'POST',
              body: JSON.stringify({ search: { ma_mau_id: id.trim() }, limit: 100, offset: 0 }),
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${POSTGRESQL_API_CONFIG.token}`
              }
            }).then(res => res.json());
          });

          // Ch·ªù t·∫•t c·∫£ API tr·∫£ v·ªÅ k·∫øt qu·∫£
          Promise.all(apiCalls)
            .then(results => {
              container.innerHTML = ''; // X√≥a ch·ªØ "ƒêang t·∫£i..."

              // Gom d·ªØ li·ªáu API v√† T√™n m·∫´u l·∫°i th√†nh 1 object d·ªÖ qu·∫£n l√Ω
              // Format: [{name: 'M1', data: [...]}, {name: 'M2', data: [...]}, ...]
              const allSamples = results.map((res, index) => ({
                name: listIds[index] || `M·∫´u ${index + 1}`,
                rows: res.data || []
              }));

              // --- LOGIC CHIA NH√ìM (CHUNKING) ---
              // Bi·∫øn allSamples ƒëang c√≥ 4 ph·∫ßn t·ª≠. H√†m n√†y s·∫Ω c·∫Øt th√†nh [[3 ph·∫ßn t·ª≠], [1 ph·∫ßn t·ª≠]]
              const groupedSamples = chunkArray(allSamples, POSTGRESQL_API_CONFIG.maxSamplesPerTable);

              // V·∫Ω t·ª´ng b·∫£ng d·ª±a tr√™n c√°c nh√≥m
              groupedSamples.forEach((group, groupIndex) => {
                const tableHTML = buildGroupTableHTML(group, groupIndex + 1);
                container.insertAdjacentHTML('beforeend', tableHTML);
              });

              // results.forEach((res, index) => {
              //     // T·∫°o b·∫£ng HTML
              //     const tableHTML = buildTableHTML(res.data, index + 1);

              //     // Ch√®n v√†o container (d√πng insertAdjacentHTML ƒë·ªÉ render chu·ªói HTML)
              //     container.insertAdjacentHTML('beforeend', tableHTML);
              // });

              // --- X·ª¨ L√ù NG·∫ÆT TRANG ---
              // G·ªçi h√†m x·ª≠ l√Ω ng·∫Øt trang sau khi ƒë√£ render xong to√†n b·ªô b·∫£ng
              handlePageBreaks();
            })
            .catch(error => {
              console.error('L·ªói API:', error);
              container.innerHTML = '<div style="color:red; text-align:center;">L·ªói t·∫£i d·ªØ li·ªáu</div>';
            });
        }

        // --- H√ÄM V·∫º B·∫¢NG G·ªòP (Dynamic Column) ---
        function buildGroupTableHTML(groupSamples, tableIndex) {
          // groupSamples l√† m·∫£ng ch·ª©a t·ª´ 1 ƒë·∫øn 3 ƒë·ªëi t∆∞·ª£ng m·∫´u
          // L·∫•y m·∫´u ƒë·∫ßu ti√™n trong nh√≥m l√†m "x∆∞∆°ng s·ªëng" ƒë·ªÉ d·ª±ng h√†ng (Ch·ªâ ti√™u, ƒë∆°n v·ªã...)
          // Gi·∫£ ƒë·ªãnh: C√°c m·∫´u trong c√πng ƒë·ª£t in c√≥ c√πng danh s√°ch ch·ªâ ti√™u
          const baseSampleRows = groupSamples[0].rows;

          // 1. X√¢y d·ª±ng Header
          let headerColsHTML = '';
          groupSamples.forEach(sample => {
            headerColsHTML += `<th>${sample.name}</th>`;
          });

          // 2. X√¢y d·ª±ng Body
          let bodyRowsHTML = '';
          if (baseSampleRows && baseSampleRows.length > 0) {
            baseSampleRows.forEach((rowBase, rowIndex) => {
              let resultCellsHTML = '';

              // L·∫∑p qua t·ª´ng m·∫´u trong nh√≥m ƒë·ªÉ l·∫•y k·∫øt qu·∫£ t∆∞∆°ng ·ª©ng c·ªßa d√≤ng n√†y
              groupSamples.forEach(sample => {
                // L·∫•y k·∫øt qu·∫£ t·∫°i d√≤ng rowIndex.
                // L∆∞u √Ω: C·∫ßn ƒë·∫£m b·∫£o th·ª© t·ª± ch·ªâ ti√™u tr·∫£ v·ªÅ t·ª´ API l√† gi·ªëng nhau gi·ªØa c√°c m·∫´u.
                const cellData = sample.rows[rowIndex] ? sample.rows[rowIndex].ket_qua_in_phieu : '-';
                resultCellsHTML += `<td>${cellData}</td>`;
              });

              bodyRowsHTML += `
                    <tr>
                      <td>${rowIndex + 1}</td>
                      <td style="text-align: left;">${rowBase.ten_chi_tieu || ''}</td>
                      <td>${rowBase.don_vi_tinh || ''}</td>
                      <td>${rowBase.phuong_phap_thu || ''}</td>
                      ${resultCellsHTML} 
                      <td>-</td>
                      <td>-</td> 
                    </tr>`;
            });
          } else {
            bodyRowsHTML = `<tr><td colspan="${4 + groupSamples.length + 2}">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
          }

          // 3. Gh√©p khung b·∫£ng
          return `
            <table class="result-table" id="tbl-${tableIndex}">
                <thead>
                    <tr>
                        <th rowspan="2" style="width: 50px">TT</th>
                        <th rowspan="2">Ch·ªâ ti√™u</th>
                        <th rowspan="2" style="width: 80px">ƒê∆°n v·ªã</th>
                        <th rowspan="2" style="width: 150px">Ph∆∞∆°ng ph√°p th·ª≠</th>
                        <th colspan="${groupSamples.length}">K·∫øt qu·∫£</th>
                        <th>QCVN 19:2009 BTNMT</th>
                        <th>QCVN 20:2009 BTNMT</th>
                    </tr>
                    <tr>
                        ${headerColsHTML}
                        <th>C·ªôt B Kp=0,8 v√† Kv=1</th>
                        <th>N·ªìng ƒë·ªô t·ªëi ƒëa</th>
                    </tr>
                </thead>
                <tbody>
                    ${bodyRowsHTML}
                </tbody>
            </table>
            `;
        }

        // --- H√ÄM T·∫†O HTML CHO 1 B·∫¢NG ---
        function buildTableHTML(dataRows, tableIndex) {
          // Header b·∫£ng
          let html = `
            <table class="result-table" id="table-${tableIndex}">
                <thead>
                    <tr>
                        <th rowspan="2" style="width: 50px">TT</th>
                        <th rowspan="2">Ch·ªâ ti√™u</th>
                        <th rowspan="2" style="width: 95px">ƒê∆°n v·ªã</th>
                        <th rowspan="2">Ph∆∞∆°ng ph√°p th·ª≠</th>
                        <th>K·∫øt qu·∫£</th>
                        <th>QCVN 19:2009 BTNMT</th>
                        <th>QCVN 20:2009 BTNMT</th>
                    </tr>
                    <tr>
                        <th><span style="color:red; font-weight:bold;"></span></th> 
                        <th>C·ªôt B Kp=0,8 v√† Kv=1</th>
                        <th>N·ªìng ƒë·ªô t·ªëi ƒëa</th>
                    </tr>
                </thead>
                <tbody>
            `;

          // Body b·∫£ng (D·ªØ li·ªáu API)
          if (dataRows && dataRows.length > 0) {
            dataRows.forEach((row, idx) => {
              html += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td style="text-align: left;">${row.ten_chi_tieu || ''}</td>
                        <td>${row.don_vi_tinh || ''}</td>
                        <td>${row.phuong_phap_thu || ''}</td>
                        <td>${row.ket_qua_in_phieu || ''}</td>
                        <td>40</td>
                        <td>-</td>
                    </tr>`;
            });
          } else {
            html += `<tr><td colspan="6">Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt</td></tr>`;
          }

          html += `</tbody></table>`;
          return html;
        }

        // --- H√ÄM X·ª¨ L√ù NG·∫ÆT TRANG (QUAN TR·ªåNG) ---
        function handlePageBreaks() {
          const tables = document.querySelectorAll('.result-table');
          if (tables.length > 0) {
            // Reset style cho t·∫•t c·∫£ b·∫£ng tr∆∞·ªõc
            tables.forEach(tbl => {
              tbl.style.pageBreakAfter = 'always';
              tbl.style.breakAfter = 'page';
              tbl.style.marginBottom = '20px';
            });

            // X·ª≠ l√Ω b·∫£ng cu·ªëi c√πng: KH√îNG ng·∫Øt trang ƒë·ªÉ d√≠nh v·ªõi footer
            const lastTable = tables[tables.length - 1];
            lastTable.style.pageBreakAfter = 'auto';
            lastTable.style.breakAfter = 'auto';
            lastTable.style.marginBottom = '0px';
          }
        }
      };
    </script>
  </body>
</html>
