<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CEFINEA | IN PHI·∫æU K·∫æT QU·∫¢</title>
    <link rel="stylesheet" href="./assets/css/form.css" />
  </head>
  <body>
    <button class="btn-print no-print" onclick="window.print()">üñ®Ô∏è In Phi·∫øu PDF</button>

    <div class="page">
      <table class="brand-table">
        <tr>
          <td class="logo-cell">
            <img src="./assets/img/form/logo.jpg" alt="Logo" class="logo-img" />
          </td>

          <td style="width: 48%; vertical-align: top">
            <div class="org-name">
              VI·ªÜN M√îI TR∆Ø·ªúNG & T√ÄI NGUY√äN<br />
              TRUNG T√ÇM C√îNG NGH·ªÜ M√îI TR∆Ø·ªúNG<br />
              PTN PH√ÇN T√çCH & K·ª∏ THU·∫¨T C√îNG NGH·ªÜ<br />
              (VIMCERTS 077)
            </div>
          </td>

          <td style="width: 53%; vertical-align: top">
            <div class="org-contact">
              Tr·ª• s·ªü ch√≠nh: 142 T√¥ Hi·∫øn Th√†nh, P.Di√™n H·ªìng, Tp.HCM<br />
              ƒê·ªãa ch·ªâ PTN: Khu ƒë√¥ th·ªã ƒê·∫°i H·ªçc Qu·ªëc Gia,<br />
              P. ƒê√¥ng H√≤a, Tp. HCM<br />
              Tel: 028.2252.4567 - Hotline: 0799435426<br />
              Email: ketquacefinea@gmail.com
            </div>
          </td>
        </tr>
      </table>

      <table class="title-box-table">
        <tr>
          <td class="so-pkq border-right-dotted">
            <div style="text-decoration: underline">S·ªë PKQ:</div>
            <div id="so_phieu" style="font-weight: bold; margin-top: 5px">.../.../PKQ</div>
          </td>
          <td class="main-title border-right-dotted">
            <div style="font-weight: bold; font-size: 16pt; text-transform: uppercase">PHI·∫æU K·∫æT QU·∫¢ TH·ª¨ NGHI·ªÜM</div>
            <div style="font-weight: bold; font-size: 14pt">TEST REPORT</div>
          </td>
          <td class="ky-hieu">
            <div style="text-decoration: underline">K√≠ hi·ªáu m·∫´u:</div>
            <div id="ky_hieu_mau" style="font-weight: bold; margin-top: 5px">...</div>
          </td>
        </tr>
      </table>

      <table class="info-table">
        <tr>
          <td class="lbl">T√™n kh√°ch h√†ng</td>
          <td>: <span id="ten_khach_hang" class="val" style="text-transform: uppercase">...</span></td>
          <td class="lbl" style="padding-left: 20px">Ng√†y nh·∫≠n m·∫´u</td>
          <td style="width: 120px">: <span id="ngay_nhan_mau">../../....</span></td>
        </tr>
        <tr>
          <td class="lbl">ƒê·ªãa ch·ªâ</td>
          <td>: <span id="dia_chi">...</span></td>
          <td class="lbl" style="padding-left: 20px">Lo·∫°i m·∫´u</td>
          <td>: <span id="loai_mau">...</span></td>
        </tr>
        <tr>
          <td class="lbl">T√™n m·∫´u</td>
          <td colspan="3">: <span id="ten_mau" style="font-weight: bold">...</span></td>
        </tr>
        <tr>
          <td class="lbl">M√¥ t·∫£ m·∫´u</td>
          <td colspan="3">: <span id="mo_ta">...</span></td>
        </tr>
      </table>

      <table class="result-table">
        <thead>
          <tr>
            <th rowspan="2" style="width: 50px">TT</th>
            <th rowspan="2">Ch·ªâ ti√™u</th>
            <th rowspan="2" style="width: 95px">ƒê∆°n v·ªã</th>
            <th rowspan="2" style="width: 200px">Ph∆∞∆°ng ph√°p th·ª≠</th>
            <th>K·∫øt qu·∫£</th>
          </tr>
          <tr>
            <th><span id="col_header_mau">...</span></th>
          </tr>
        </thead>
        <tbody id="table_body">
          <tr>
            <td>1</td>
            <td style="text-align: left">D·∫ßu m·ª° ƒë·ªông, th·ª±c v·∫≠t(b)</td>
            <td>mg/L</td>
            <td>SMEWW 5520B&F:2023</td>
            <td>KPH(LOD=1)</td>
          </tr>
        </tbody>
      </table>

      <div class="notes">
        <span style="text-decoration: underline; font-weight: bold">Ghi ch√∫:</span><br />
        1. (b)- Th√¥ng s·ªë ƒë√£ ƒë∆∞·ª£c B·ªô T√†i nguy√™n v√† M√¥i tr∆∞·ªùng c√¥ng nh·∫≠n (S·ªë hi·ªáu VIMCERTS 077);<br />
        2. KPH: Kh√¥ng ph√°t hi·ªán; LOD: Gi·ªõi h·∫°n ph√°t hi·ªán c·ªßa ph∆∞∆°ng ph√°p;<br />
        3. Th√¥ng tin t√™n kh√°ch h√†ng v√† m·∫´u th·ª≠ ƒë∆∞·ª£c ghi tr√™n phi·∫øu k·∫øt qu·∫£ n√†y theo y√™u c·∫ßu kh√°ch h√†ng;<br />
        4. C√°c k·∫øt qu·∫£ ph√¢n t√≠ch ch·ªâ c√≥ gi√° tr·ªã tr√™n m·∫´u th·ª≠/t·∫°i th·ªùi ƒëi·ªÉm ƒëo;<br />
        5. Th·ªùi gian l∆∞u m·∫´u: 7 ng√†y k·ªÉ t·ª´ ng√†y tr·∫£ k·∫øt qu·∫£ ƒë·ªëi v·ªõi m·∫´u ƒë·∫•t, n∆∞·ªõc, b√πn, ch·∫•t th·∫£i, kh√¥ng l∆∞u ƒë·ªëi v·ªõi m·∫´u
        kh√≠, vi sinh;<br />
        6. Kh√¥ng ƒë∆∞·ª£c tr√≠ch sao m·ªôt ph·∫ßn ho·∫∑c to√†n b·ªô phi·∫øu k·∫øt qu·∫£ th·ª≠ nghi·ªám n·∫øu kh√¥ng c√≥ s·ª± ƒë·ªìng √Ω c·ªßa Trung t√¢m C√¥ng
        ngh·ªá M√¥i tr∆∞·ªùng.
      </div>

      <div class="footer-date" id="footer_date">Tp. H·ªì Ch√≠ Minh, ng√†y ... th√°ng ... nƒÉm ...</div>

      <table class="signature-table">
        <tbody>
          <tr>
            <td style="width: 33%">
              <span class="signature-title">Ph·ª• tr√°ch k·ªπ thu·∫≠t</span>
              <span class="signature-name">KS. Tr·∫ßn Th·ªã Ph∆∞∆°ng Linh</span>
            </td>
            <td style="width: 33%">
              <span class="signature-title">Tr∆∞·ªüng ph√≤ng PTN</span>
              <span class="signature-name">ThS. Phan Th·ªã Ho√†i Trinh</span>
            </td>
            <td style="width: 33%">
              <span class="signature-title">Gi√°m ƒë·ªëc</span>
              <span class="signature-name">TS. Nguy·ªÖn Nh∆∞ Hi·ªÉn</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      // H√†m l·∫•y tham s·ªë t·ª´ URL
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      // H√†m ƒëi·ªÅn d·ªØ li·ªáu v√†o form khi trang t·∫£i xong
      window.onload = function () {
        // Danh s√°ch c√°c tr∆∞·ªùng c·∫ßn ƒëi·ªÅn (id trong HTML : t√™n tham s·ªë tr√™n URL)
        const fields = {
          so_phieu: 'so_phieu',
          ky_hieu_mau: 'ky_hieu_mau',
          ten_khach_hang: 'ten_khach_hang',
          dia_chi: 'dia_chi',
          ngay_nhan_mau: 'ngay_nhan_mau',
          ten_mau: 'ten_mau',
          loai_mau: 'loai_mau',
          mo_ta: 'mo_ta',
          footer_date: 'ngay_in'
        };

        // L·∫∑p v√† ƒëi·ªÅn d·ªØ li·ªáu text c∆° b·∫£n
        for (const [id, param] of Object.entries(fields)) {
          const value = getQueryParam(param);

          // N·∫øu l√† footer_date, ƒë·ªãnh d·∫°ng ng√†y th√°ng (tham s·ªë nh·∫≠n l√† dd/mm/yyyy)
          if (id === 'footer_date' && value) {
            const parts = value.split('/');
            const date = new Date(parts[2], parts[1] - 1, parts[0]);
            const formattedDate = `${date.getDate()} th√°ng ${date.getMonth() + 1} nƒÉm ${date.getFullYear()}`;
            document.getElementById(id).innerText = `Tp. H·ªì Ch√≠ Minh, ng√†y ${formattedDate}`;
            continue;
          }

          if (value) {
            document.getElementById(id).innerText = decodeURIComponent(value);
          }
        }
        // ?so_phieu=12/2025/PKQ&ky_hieu_mau=25.4999.NT1&ten_khach_hang=C√îNG%20TY%20A&ngay_nhan_mau=04/12/2025&dia_chi=T·ªânh%20B&loai_mau=N∆∞·ªõc%20th·∫£i&ten_mau=25.4999.NT1&mo_ta=25.4999.NT1:%20m·∫´u%20n∆∞·ªõc%20v√†ng%20nh·∫°t%20-%20ƒë∆∞·ª£c%20kh√°ch%20h√†ng%20mang%20ƒë·∫øn&ngay_in=14/12/2025&ma_mau_id=13e9024c
        // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho b·∫£ng k·∫øt qu·∫£ (N·∫øu truy·ªÅn JSON qua URL)
        // L·∫•y tham s·ªë ma_mau_id
        const maMauId = getQueryParam('ma_mau_id');
        // C·∫•u h√¨nh API PostgreSQL
        const POSTGRESQL_API_CONFIG = {
          baseUrl: 'https://api-cefinea.tamk.win',
          endpoints: {
            chiTietMau: '/cefinea/chi-tiet-mau/search'
          },
          token: 'GPEMS-zzzz'
        };
        // D·ª±a tr√™n m√£ m·∫´u id n√†y fetch api get danh s√°ch chi-tiet-mau c√≥ ma_mau_id t∆∞∆°ng ·ª©ng
        if (maMauId) {
          document.getElementById('col_header_mau').innerText = maMauId;
          fetch(`${POSTGRESQL_API_CONFIG.baseUrl}${POSTGRESQL_API_CONFIG.endpoints.chiTietMau}`, {
            method: 'POST',
            body: JSON.stringify({
              search: {
                ma_mau_id: maMauId
              },
              limit: 100,
              offset: 0
            }),
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${POSTGRESQL_API_CONFIG.token}`
            }
          })
            .then(response => response.json())
            .then(res => {
              console.log('D·ªØ li·ªáu b·∫£ng t·ª´ API:', res);
              const tbody = document.getElementById('table_body');
              tbody.innerHTML = ''; // X√≥a d·ªØ li·ªáu m·∫´u

              res.data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                              <td>${index + 1}</td>
                              <td style="text-align: left;">${row.ten_chi_tieu || ''}</td>
                              <td>${row.don_vi_tinh || ''}</td>
                              <td>${row.phuong_phap_thu || ''}</td>
                              <td>${row.ket_qua_in_phieu || ''}</td>
                          `;
                tbody.appendChild(tr);
              });
            })
            .catch(error => {
              console.error('L·ªói khi l·∫•y d·ªØ li·ªáu b·∫£ng t·ª´ API', error);
            });
        } else {
          // N·∫øu kh√¥ng c√≥ ma_mau_id, gi·ªØ nguy√™n m·∫´u ho·∫∑c x·ª≠ l√Ω m·∫∑c ƒë·ªãnh
          // Code m·∫´u ·ªü HTML ƒë√£ c√≥ s·∫µn 1 d√≤ng
        }
      };
    </script>
  </body>
</html>
